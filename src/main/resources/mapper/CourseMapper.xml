<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//ibatis.apache.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.xmu.cms.mapper.CourseMapper">
    <resultMap id="CourseResultMap" type="com.xmu.cms.entity.Course">
        <id property="courseId" column="courseId" javaType="java.math.BigInteger"/>
        <result property="courseName" column="courseName"/>
        <result property="introduction" column="introduction"/>
        <result property="presentationWeight" column="presentationWeight"/>
        <result property="reportWeight" column="reportWeight"/>
        <result property="questionWeight" column="questionWeight"/>
        <result property="teamStartTime" column="teamStartDate"/>
        <result property="teamEndTime" column="teamEndDate"/>
        <association property="teacher" javaType="com.xmu.cms.entity.Teacher">
            <id property="teacherId" column="teacherId"/>
            <result property="name" column="teacherName"/>
            <result property="email" column="teacherEmail"/>
        </association>
        <collection property="klasses" javaType="com.xmu.cms.entity.Klass">
            <id property="klassId" column="klassId"/>
            <result property="grade" column="grade"/>
            <result property="klassSerial" column="klassSerial"/>
        </collection>
    </resultMap>

    <select id="getAllCourseByTeacherId" resultMap="CourseResultMap">
        SELECT course.id            as courseId,
               teacher.id           as teacherId,
               teacher.email        as teacherEmail,
               teacher.teacher_name as teacherName,
               course_name          as courseName,
               introduction,
               presentation_percentage       as presentationWeight,
               report_percentage             as reportWeight,
               question_percentage           as questionWeight,
               team_start_time      as teamStartDate,
               team_end_time        as teamEndDate,
               klass.id             as klassId,
               klass.grade          as grade,
               klass.klass_serial   as klassSerial
        FROM course,
             teacher,
             klass
        WHERE teacher.id = #{teacherId}
          AND teacher.id = course.teacher_id
          and klass.course_id = course.id
    </select>

    <select id="getAllCourseByStudentId" resultType="com.xmu.cms.entity.Course">
        SELECT course.id            as courseId,
               teacher.id           as teacherId,
               teacher.email        as teacherEmail,
               teacher.teacher_name as teacherName,
               course_name          as courseName,
               introduction,
               presentation_percentage       as presentationWeight,
               report_percentage             as reportWeight,
               question_percentage           as questionWeight,
               team_start_time      as teamStartDate,
               team_end_time        as teamEndDate,
               klass.id             as klassId,
               klass.grade          as grade,
               klass.klass_serial   as klassSerial
        FROM course,
             teacher,
             klass,
             klass_student
        WHERE klass_student.student_id = #{studentId}
          AND klass_student.klass_id = klass.id
          AND klass.course_id = course.id
          AND course.teacher_id = teacher.id
    </select>

    <select id="getCourseById" resultMap="CourseResultMap">
        SELECT course.id            as courseId,
               teacher.id           as teacherId,
               teacher.email        as teacherEmail,
               teacher.teacher_name as teacherName,
               course_name          as courseName,
               introduction,
               presentation_percentage       as presentationWeight,
               report_percentage             as reportWeight,
               question_percentage           as questionWeight,
               team_start_time      as teamStartDate,
               team_end_time        as teamEndDate,
               klass.id             as klassId,
               klass.grade          as grade,
               klass.klass_serial   as klassSerial
        FROM course,
             teacher,
             klass
        WHERE course.id = #{courseId}
          AND teacher.id = course.teacher_id
          and klass.course_id = course.id
    </select>

    <delete id="deleteCourseById">
        DELETE *
        FROM course
        WHERE id = #{courseId}
    </delete>

    <insert id="createCourse" parameterType="com.xmu.cms.entity.Course">
        insert into course (id,
                            teacher_id,
                            course_name,
                            introduction,
                            presentation_percentage,
                            report_percentage,
                            question_percentage,
                            team_start_time,
                            team_end_time)
        values (#{course.courseId},
                #{course.teacher.teacherId},
                #{course.courseName},
                #{course.introduction},
                #{course.presentationWeight},
                #{course.reportWeight},
                #{course.questionWeight},
                #{course.teamStartDate},
                #{course.teamEndDate})
    </insert>

    <select id="getMainShareCourseByTeacher" resultMap="CourseResultMap">
        SELECT course1.id            as courseId,
               teacher.id           as teacherId,
               teacher.email        as teacherEmail,
               teacher.teacher_name as teacherName,
               course1.course_name          as courseName,
               course1.introduction,
               course1.presentation_percentage       as presentationWeight,
               course1.report_percentage             as reportWeight,
               course1.question_percentage           as questionWeight,
               course1.team_start_time      as teamStartDate,
               course1.team_end_time        as teamEndDate,
               klass.id             as klassId,
               klass.grade          as grade,
               klass.klass_serial   as klassSerial
        FROM course course1,
             teacher,
             klass,
             course course2
        WHERE course1.teacher_id = #{teacherId}
          AND teacher.id = #{teacherId}
          and (course2.team_main_course_id = course1.id or course2.seminar_main_course_id = course1.id)
          and klass.course_id = course1.id
    </select>

    <select id="getSubShareCourseByTeacher" resultMap="CourseResultMap">
        SELECT course.id            as courseId,
               teacher.id           as teacherId,
               teacher.email        as teacherEmail,
               teacher.teacher_name as teacherName,
               course.course_name          as courseName,
               course.introduction,
               course.presentation_percentage       as presentationWeight,
               course.report_percentage             as reportWeight,
               course.question_percentage           as questionWeight,
               course.team_start_time      as teamStartDate,
               course.team_end_time        as teamEndDate,
               klass.id             as klassId,
               klass.grade          as grade,
               klass.klass_serial   as klassSerial
        FROM course,
             teacher,
             klass
        WHERE course.teacher_id = #{teacherId}
          AND teacher.id = #{teacherId}
          and (course.seminar_main_course_id is not null or course.team_main_course_id is not null )
          and klass.course_id = course.id
    </select>
</mapper>